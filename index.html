<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Geomorfología Optimizado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map {
      height: 95vh;
      width: 98%;
      margin: auto;
    }
    .info {
      background: white;
      padding: 8px;
      font-size: 13px;
      border-radius: 4px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
/* ======================================================
   MAPA
====================================================== */
const map = L.map("map", {
  preferCanvas: true
}).setView([38.79, -0.40], 10);

/* ======================================================
   CAPA BASE WMTS IGN (rápida)
====================================================== */
const ignWMTS = L.tileLayer(
  "https://www.ign.es/wmts/ign-base?layer=IGNBaseTodo&style=default&tilematrixset=GoogleMapsCompatible&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/png&TileMatrix={z}&TileRow={y}&TileCol={x}",
  {
    attribution: "© Instituto Geográfico Nacional"
  }
).addTo(map);

/* ======================================================
   PANEL PARA GEOJSON (mejor rendimiento)
====================================================== */
map.createPane("geojsonPane");
map.getPane("geojsonPane").style.zIndex = 450;

/* ======================================================
   SIMBOLOGÍA POR ATRIBUTOS
====================================================== */
function colorGeomorfologia(tipo) {
  switch (tipo) {
    case "Ladera": return "#a6611a";
    case "Barranco": return "#018571";
    case "Terraza": return "#dfc27d";
    case "Abanico": return "#80cdc1";
    default: return "#999999";
  }
}

function estiloGeomorfologia(feature) {
  return {
    pane: "geojsonPane",
    color: "#444",
    weight: 1,
    fillColor: colorGeomorfologia(feature.properties.TIPO),
    fillOpacity: 0.6
  };
}

/* ======================================================
   GEOJSON – CANYADES
====================================================== */
const capaCanyades = L.geoJSON(null, {
  pane: "geojsonPane",
  style: {
    color: "red",
    weight: 2
  },
  onEachFeature: (feature, layer) => {
    layer.bindPopup(
      `<b>${feature.properties.NOMBRE || "Canyada"}</b>`
    );
  }
}).addTo(map);

fetch("https://raw.githubusercontent.com/medspai/geomorphology/main/1canyades_benferri4326.json")
  .then(r => r.json())
  .then(data => {
    capaCanyades.addData(data);
    map.fitBounds(capaCanyades.getBounds());
  });

/* ======================================================
   GEOJSON – GEOMORFOLOGÍA
====================================================== */
const capaGeomorfologia = L.geoJSON(null, {
  style: estiloGeomorfologia,
  onEachFeature: (feature, layer) => {
    let html = "<b>Geomorfología</b><br>";
    for (let k in feature.properties) {
      html += `<b>${k}:</b> ${feature.properties[k]}<br>`;
    }
    layer.bindPopup(html);
  }
}).addTo(map);

fetch("https://raw.githubusercontent.com/medspai/geomorphology/main/geomorfologia.wgs84.geojson")
  .then(r => r.json())
  .then(data => capaGeomorfologia.addData(data));

/* ======================================================
   CONTROL DE CAPAS
====================================================== */
L.control.layers(
  { "IGN Base (WMTS)": ignWMTS },
  {
    "Canyades": capaCanyades,
    "Geomorfología": capaGeomorfologia
  },
  { collapsed: false }
).addTo(map);

/* ======================================================
   ESCALA
====================================================== */
L.control.scale({
  position: "bottomleft",
  metric: true,
  imperial: false
}).addTo(map);

/* ======================================================
   COORDENADAS EN TIEMPO REAL
====================================================== */
const coords = L.control({ position: "bottomright" });
coords.onAdd = function () {
  this.div = L.DomUtil.create("div", "info");
  this.update();
  return this.div;
};
coords.update = function (latlng) {
  this.div.innerHTML = latlng
    ? `Lat: ${latlng.lat.toFixed(5)}<br>Lng: ${latlng.lng.toFixed(5)}`
    : "Mueve el cursor";
};
coords.addTo(map);

map.on("mousemove", e => coords.update(e.latlng));

/* ======================================================
   LEYENDA
====================================================== */
const legend = L.control({ position: "topright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "info legend");
  div.innerHTML = `
    <b>Geomorfología</b><br>
    <i style="background:#a6611a"></i>Ladera<br>
    <i style="background:#018571"></i>Barranco<br>
    <i style="background:#dfc27d"></i>Terraza<br>
    <i style="background:#80cdc1"></i>Abanico
  `;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
