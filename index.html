<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Geomorfolog√≠a Optimizado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map {
      height: 95vh;
      width: 98%;
      margin: auto;
    }
    .info {
      background: white;
      padding: 8px;
      font-size: 13px;
      border-radius: 4px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    /* Estilos para el panel de filtros */
    .filter-panel {
      background: white;
      padding: 12px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 200px;
    }
    .filter-panel h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: bold;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }
    .filter-item {
      margin: 6px 0;
      display: flex;
      align-items: center;
    }
    .filter-item input {
      margin-right: 6px;
      cursor: pointer;
    }
    .filter-item label {
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
    }
    .color-indicator {
      width: 16px;
      height: 16px;
      display: inline-block;
      margin-left: 6px;
      border: 1px solid #333;
      border-radius: 2px;
    }
    .scale-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
/* ======================================================
   MAPA
====================================================== */
const map = L.map("map", {
  preferCanvas: true
}).setView([38.79, -0.40], 10);

/* ======================================================
   CAPA BASE WMTS IGN (r√°pida)
====================================================== */
const ignWMTS = L.tileLayer(
  "https://www.ign.es/wmts/ign-base?layer=IGNBaseTodo&style=default&tilematrixset=GoogleMapsCompatible&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/png&TileMatrix={z}&TileRow={y}&TileCol={x}",
  {
    attribution: "¬© Instituto Geogr√°fico Nacional"
  }
).addTo(map);

/* ======================================================
   PANEL PARA GEOJSON (mejor rendimiento)
====================================================== */
map.createPane("geojsonPane");
map.getPane("geojsonPane").style.zIndex = 450;

/* ======================================================
   ESTADO DE FILTROS
====================================================== */
const filtrosActivos = {
  "Ladera": true,
  "Barranco": true,
  "Terraza": true,
  "Abanico": true
};

/* ======================================================
   SIMBOLOG√çA POR ATRIBUTOS
====================================================== */
function colorGeomorfologia(tipo) {
  switch (tipo) {
    case "Ladera": return "#a6611a";
    case "Barranco": return "#018571";
    case "Terraza": return "#dfc27d";
    case "Abanico": return "#80cdc1";
    default: return "#999999";
  }
}

function estiloGeomorfologia(feature) {
  return {
    pane: "geojsonPane",
    color: "#444",
    weight: 1,
    fillColor: colorGeomorfologia(feature.properties.TIPO),
    fillOpacity: 0.6
  };
}

/* ======================================================
   FUNCI√ìN DE FILTRADO
====================================================== */
function filtrarPorTipo(feature) {
  const tipo = feature.properties?.TIPO || "Desconocido";
  return filtrosActivos[tipo] !== false;
}

/* ======================================================
   GEOJSON ‚Äì CANYADES
====================================================== */
const capaCanyades = L.geoJSON(null, {
  pane: "geojsonPane",
  style: {
    color: "red",
    weight: 2
  },
  onEachFeature: (feature, layer) => {
    layer.bindPopup(
      `<b>${feature.properties.NOMBRE || "Canyada"}</b>`
    );
  }
}).addTo(map);

fetch("https://raw.githubusercontent.com/medspai/geomorphology/main/1canyades_benferri4326.json")
  .then(r => r.json())
  .then(data => {
    capaCanyades.addData(data);
    map.fitBounds(capaCanyades.getBounds());
  })
  .catch(err => {
    console.error("Error cargando canyades:", err);
    alert("No se pudo cargar la capa de canyades");
  });

/* ======================================================
   GEOJSON ‚Äì GEOMORFOLOG√çA
====================================================== */
let datosGeomorfologia = null; // Guardamos los datos originales

const capaGeomorfologia = L.geoJSON(null, {
  style: estiloGeomorfologia,
  filter: filtrarPorTipo,
  onEachFeature: (feature, layer) => {
    let html = "<b>Geomorfolog√≠a</b><br>";
    for (let k in feature.properties) {
      html += `<b>${k}:</b> ${feature.properties[k]}<br>`;
    }
    layer.bindPopup(html);
  }
}).addTo(map);

fetch("https://raw.githubusercontent.com/medspai/geomorphology/main/geomorfologia.wgs84.geojson")
  .then(r => r.json())
  .then(data => {
    datosGeomorfologia = data;
    capaGeomorfologia.addData(data);
  })
  .catch(err => {
    console.error("Error cargando geomorfolog√≠a:", err);
    alert("No se pudo cargar la capa de geomorfolog√≠a");
  });

/* ======================================================
   FUNCI√ìN PARA ACTUALIZAR CAPA CON FILTROS
====================================================== */
function actualizarCapaGeomorfologia() {
  capaGeomorfologia.clearLayers();
  if (datosGeomorfologia) {
    capaGeomorfologia.addData(datosGeomorfologia);
  }
}

/* ======================================================
   CONTROL DE ESCALA - Ocultar a escala < 1:50.000
====================================================== */
let capaVisible = true;

function verificarEscala() {
  const zoom = map.getZoom();
  // Zoom 13 aproximadamente corresponde a 1:50.000
  // A menor zoom (m√°s alejado), mayor escala
  const warningDiv = document.querySelector('.scale-warning');
  
  if (zoom < 13) {
    // Escala muy peque√±a (< 1:50.000), ocultar capa
    if (capaVisible) {
      map.removeLayer(capaGeomorfologia);
      capaVisible = false;
      if (warningDiv) {
        warningDiv.style.display = 'block';
      }
    }
  } else {
    // Escala adecuada, mostrar capa
    if (!capaVisible) {
      map.addLayer(capaGeomorfologia);
      capaVisible = true;
      if (warningDiv) {
        warningDiv.style.display = 'none';
      }
    }
  }
}

map.on('zoomend', verificarEscala);
verificarEscala(); // Verificar al cargar

/* ======================================================
   PANEL DE FILTROS
====================================================== */
const filtrosControl = L.control({ position: "topleft" });

filtrosControl.onAdd = function () {
  const div = L.DomUtil.create("div", "filter-panel");
  
  div.innerHTML = `
    <h4>üîç Filtros Geomorfolog√≠a</h4>
    <div class="filter-item">
      <input type="checkbox" id="filtro-ladera" checked>
      <label for="filtro-ladera">
        Ladera
        <span class="color-indicator" style="background:#a6611a"></span>
      </label>
    </div>
    <div class="filter-item">
      <input type="checkbox" id="filtro-barranco" checked>
      <label for="filtro-barranco">
        Barranco
        <span class="color-indicator" style="background:#018571"></span>
      </label>
    </div>
    <div class="filter-item">
      <input type="checkbox" id="filtro-terraza" checked>
      <label for="filtro-terraza">
        Terraza
        <span class="color-indicator" style="background:#dfc27d"></span>
      </label>
    </div>
    <div class="filter-item">
      <input type="checkbox" id="filtro-abanico" checked>
      <label for="filtro-abanico">
        Abanico
        <span class="color-indicator" style="background:#80cdc1"></span>
      </label>
    </div>
    <div class="scale-warning">
      ‚ö†Ô∏è Ac√©rcate m√°s para ver la capa (zoom < 13)
    </div>
  `;
  
  // Prevenir que los clicks en el panel afecten al mapa
  L.DomEvent.disableClickPropagation(div);
  
  return div;
};

filtrosControl.addTo(map);

/* ======================================================
   CONTROL DE CAPAS
====================================================== */
L.control.layers(
  { "IGN Base (WMTS)": ignWMTS },
  {
    "Canyades": capaCanyades,
    "Geomorfolog√≠a": capaGeomorfologia
  },
  { collapsed: false }
).addTo(map);

/* ======================================================
   ESCALA
====================================================== */
L.control.scale({
  position: "bottomleft",
  metric: true,
  imperial: false
}).addTo(map);

/* ======================================================
   COORDENADAS EN TIEMPO REAL
====================================================== */
const coords = L.control({ position: "bottomright" });
coords.onAdd = function () {
  this.div = L.DomUtil.create("div", "info");
  this.update();
  return this.div;
};
coords.update = function (latlng) {
  this.div.innerHTML = latlng
    ? `Lat: ${latlng.lat.toFixed(5)}<br>Lng: ${latlng.lng.toFixed(5)}<br>Zoom: ${map.getZoom()}`
    : "Mueve el cursor";
};
coords.addTo(map);

map.on("mousemove", e => coords.update(e.latlng));

/* ======================================================
   LEYENDA
====================================================== */
const legend = L.control({ position: "topright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "info legend");
  div.innerHTML = `
    <b>Geomorfolog√≠a</b><br>
    <i style="background:#a6611a"></i>Ladera<br>
    <i style="background:#018571"></i>Barranco<br>
    <i style="background:#dfc27d"></i>Terraza<br>
    <i style="background:#80cdc1"></i>Abanico
  `;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
