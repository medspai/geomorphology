<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Geomorfología Optimizado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .info {
      background: white;
      padding: 8px;
      font-size: 13px;
      border-radius: 4px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>

<body>
<div id="map"></div>

<!-- Cargar Leaflet ANTES del script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Esperar a que el DOM y Leaflet estén listos
document.addEventListener('DOMContentLoaded', function() {

/* ======================================================
   MAPA
====================================================== */
const map = L.map("map", {
  preferCanvas: true
}).setView([38.79, -0.40], 10);

/* ======================================================
   CAPA BASE WMTS IGN (rápida)
====================================================== */
const ignWMTS = L.tileLayer(
  "https://www.ign.es/wmts/ign-base?layer=IGNBaseTodo&style=default&tilematrixset=GoogleMapsCompatible&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/png&TileMatrix={z}&TileRow={y}&TileCol={x}",
  {
    attribution: "© Instituto Geográfico Nacional"
  }
).addTo(map);

/* ======================================================
   CAPA WMS - ISOHIPSAS ICV
====================================================== */
const wmsIsohipsas = L.tileLayer.wms(
  "https://terramapas.icv.gva.es/mapabase_isohipsas/wms",
  {
    layers: "isohipsas",
    format: "image/png",
    transparent: true,
    attribution: "© Institut Cartogràfic Valencià"
  }
);

/* ======================================================
   PANEL PARA GEOJSON (mejor rendimiento)
====================================================== */
map.createPane("geojsonPane");
map.getPane("geojsonPane").style.zIndex = 450;

/* ======================================================
   SIMBOLOGÍA POR ATRIBUTOS
====================================================== */
function colorGeomorfologia(tipo) {
  switch (tipo) {
    case "Ladera": return "#a6611a";
    case "Barranco": return "#018571";
    case "Terraza": return "#dfc27d";
    case "Abanico": return "#80cdc1";
    default: return "#999999";
  }
}

function estiloGeomorfologia(feature) {
  return {
    pane: "geojsonPane",
    color: "#444",
    weight: 1,
    fillColor: colorGeomorfologia(feature.properties.TIPO),
    fillOpacity: 0.6
  };
}

/* ======================================================
   GEOJSON – CANYADES
====================================================== */
const capaCanyades = L.geoJSON(null, {
  pane: "geojsonPane",
  style: {
    color: "red",
    weight: 2
  },
  onEachFeature: (feature, layer) => {
    layer.bindPopup(
      `<b>${feature.properties.NOMBRE || "Canyada"}</b>`
    );
  }
}).addTo(map);

fetch("https://raw.githubusercontent.com/medspai/geomorphology/main/1canyades_benferri4326.json")
  .then(r => r.json())
  .then(data => {
    capaCanyades.addData(data);
    map.fitBounds(capaCanyades.getBounds());
  })
  .catch(err => {
    console.error("Error cargando canyades:", err);
    alert("No se pudo cargar la capa de canyades");
  });

/* ======================================================
   GEOJSON – GEOMORFOLOGÍA
====================================================== */
let datosGeomorfologia = null;

const capaGeomorfologia = L.geoJSON(null, {
  style: estiloGeomorfologia,
  onEachFeature: (feature, layer) => {
    let html = "<b>Geomorfología</b><br>";
    for (let k in feature.properties) {
      html += `<b>${k}:</b> ${feature.properties[k]}<br>`;
    }
    layer.bindPopup(html);
  }
}).addTo(map);

fetch("https://raw.githubusercontent.com/medspai/geomorphology/main/geomorfologia.wgs84.geojson")
  .then(r => r.json())
  .then(data => {
    datosGeomorfologia = data;
    capaGeomorfologia.addData(data);
  })
  .catch(err => {
    console.error("Error cargando geomorfología:", err);
    alert("No se pudo cargar la capa de geomorfología");
  });

/* ======================================================
   CONTROL DE ESCALA - Ocultar geomorfología cuando zoom >= 13
====================================================== */
let capaGeomorfologiaVisible = true;

function verificarEscalaGeomorfologia() {
  const zoom = map.getZoom();
  
  if (zoom >= 13) {
    // Zoom cercano (>= 13), ocultar capa geomorfología
    if (capaGeomorfologiaVisible && map.hasLayer(capaGeomorfologia)) {
      map.removeLayer(capaGeomorfologia);
      capaGeomorfologiaVisible = false;
      console.log("Geomorfología oculta - zoom >= 13");
    }
  } else {
    // Zoom alejado (< 13), mostrar capa geomorfología
    if (!capaGeomorfologiaVisible) {
      map.addLayer(capaGeomorfologia);
      capaGeomorfologiaVisible = true;
      console.log("Geomorfología visible - zoom < 13");
    }
  }
}

map.on('zoomend', verificarEscalaGeomorfologia);
verificarEscalaGeomorfologia(); // Verificar al cargar

/* ======================================================
   CONTROL DE CAPAS
====================================================== */
L.control.layers(
  { "IGN Base (WMTS)": ignWMTS },
  {
    "Isohipsas ICV": wmsIsohipsas,
    "Canyades": capaCanyades,
    "Geomorfología": capaGeomorfologia
  },
  { collapsed: false }
).addTo(map);

/* ======================================================
   ESCALA
====================================================== */
L.control.scale({
  position: "bottomleft",
  metric: true,
  imperial: false
}).addTo(map);

/* ======================================================
   COORDENADAS EN TIEMPO REAL
====================================================== */
const coords = L.control({ position: "bottomright" });
coords.onAdd = function () {
  this.div = L.DomUtil.create("div", "info");
  this.update();
  return this.div;
};
coords.update = function (latlng) {
  this.div.innerHTML = latlng
    ? `Lat: ${latlng.lat.toFixed(5)}<br>Lng: ${latlng.lng.toFixed(5)}<br>Zoom: ${map.getZoom()}`
    : "Mueve el cursor";
};
coords.addTo(map);

map.on("mousemove", e => coords.update(e.latlng));

/* ======================================================
   LEYENDA
====================================================== */
const legend = L.control({ position: "topright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "info legend");
  div.innerHTML = `
    <b>Geomorfología</b><br>
    <i style="background:#a6611a"></i>Ladera<br>
    <i style="background:#018571"></i>Barranco<br>
    <i style="background:#dfc27d"></i>Terraza<br>
    <i style="background:#80cdc1"></i>Abanico
  `;
  return div;
};
legend.addTo(map);

}); // Fin del DOMContentLoaded
</script>
</body>
</html>
